<!DOCTYPE html>
<html>
<header>
    <meta charset="utf-8">
    <title>TESTING CHART JS</title>

    <!-- Chart js bundle min -->
    <script src="https://www.chartjs.org/dist/2.9.4/Chart.min.js"></script>
    <script src="https://www.chartjs.org/samples/latest/utils.js"></script>

    <!-- Jquery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.js"></script>

    <!-- Open Sans Font -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
</header>

<body>
    <div style="height:50vh">
        <canvas id="myChart"></canvas>
    </div>


    <script>
        var sheets_api_key = "AIzaSyBCKARaVh3Ho0f5NEdAfvzTi5_U-UgkNLM"

        // get color 
        var lineOptions = {
            colors: ["rgba(255, 255, 255, 1)", 
                "rgba(0, 175, 181, 1)", 
                "rgba(255, 119, 0, 1)",
                "rgba(163, 0, 0, 1)", 
                "rgba(0, 71, 119, 1)", 
                "rgba(239, 210, 141, 1)"]
        }

        // Multi Right-Axis Example

        //var link = FormatLink("1nXewUdMlnsuKIGhVxP-Pk36aJwXFbS14jTc7mocK2FU", "Sheet2!A:E")

        var link = FormatLink("1nXewUdMlnsuKIGhVxP-Pk36aJwXFbS14jTc7mocK2FU", "Sheet2!A1:E7", "Sheet2!A28:E96")
        //var link = FormatLink("1nXewUdMlnsuKIGhVxP-Pk36aJwXFbS14jTc7mocK2FU", "Sheet2!A1:D7")

        SetupDualAxisLineChart('myChart', link, 3);
        
            //MULTIRANGED
            //https://sheets.googleapis.com/v4/spreadsheets/1nXewUdMlnsuKIGhVxP-Pk36aJwXFbS14jTc7mocK2FU/values:batchGet?ranges=Sheet2!A1:E7&ranges=Sheet2!A28:E96&majorDimension=COLUMNS&key=AIzaSyBCKARaVh3Ho0f5NEdAfvzTi5_U-UgkNLM

            //SINGLE RANGE
            //https://sheets.googleapis.com/v4/spreadsheets/1nXewUdMlnsuKIGhVxP-Pk36aJwXFbS14jTc7mocK2FU/values:batchGet?ranges=Sheet2!A:E&majorDimension=COLUMNS&key=AIzaSyBCKARaVh3Ho0f5NEdAfvzTi5_U-UgkNLM

            //SEPARATE HEADERS
            //https://sheets.googleapis.com/v4/spreadsheets/1nXewUdMlnsuKIGhVxP-Pk36aJwXFbS14jTc7mocK2FU/values:batchGet?ranges=Sheet2!A1:E1&ranges=Sheet2!A21:E96&majorDimension=COLUMNS&key=AIzaSyBCKARaVh3Ho0f5NEdAfvzTi5_U-UgkNLM

        function FormatLink(spreadSheetID, ...ranges)
        {
            var link;
            const startOfLink = "https://sheets.googleapis.com/v4/spreadsheets/";
            const forceColumns = "&majorDimension=COLUMNS"
            const apiKey = "&key=" + sheets_api_key;

            var range = "";
            ranges.forEach(element => {
                if (range == "")
                {
                    range = "/values:batchGet?ranges=" + element;
                }
                else
                {
                    range = range + "&ranges=" + element;
                }
            });

            link = startOfLink + spreadSheetID + range + forceColumns + apiKey;

            console.log(link);
            return link;
        }

        // e['values'][0][?][0] = dataHeader
        // e['values'][0][?][0]

        function OldJSONCode(link)
        {
            $.getJSON(link, json => 
            {
                var data = [];
                var dataHeaders = new Array(size);

                for (var i = 0; i < size; i++)
                {
                    data[i] = new Array();
                }

                json.feed.entry.forEach((e) => 
                {
                    const column = Number(e['gs$cell']['col']);
                    const row = Number(e['gs$cell']['row']);

                    const dataNum = Number(e['gs$cell']['col']) - 1;

                    //Data is header/name
                    if (row == 1)
                    {
                        dataHeaders[dataNum] = e['gs$cell']['$t'];
                        
                        //Moves to next element
                        return;
                    }

                    var value = e['gs$cell']['$t'];
                    if (column != 1)
                    {
                        Number(value);
                    }
                    data[dataNum].push(value);
                });
            });
        }


        function SetupDualAxisLineChart(chartName, link, ...rightAxis)
        {
            $.getJSON(link, json => 
            {
                const size = json.valueRanges[0].values.length;
                
                var data = [];
                var dataHeaders = new Array(size);

                for (var i = 0; i < size; i++)
                {
                    data[i] = new Array();
                }

                var firstValueRange = true; 
                
                // Iterate all VALUE RANGES
                json.valueRanges.forEach(valueRange => {

                    var amountOfColumns = valueRange.values.length;

                    // Iterate all VALUES arrays
                    for (var column = 0; column < amountOfColumns; column++)
                    {
                        var values = valueRange.values[column];

                        var amountOfRows = values.length;

                        for (var row = 0; row < amountOfRows; row++)
                        {
                            var value = values[row];

                            if (firstValueRange & row == 0)
                            {
                                dataHeaders[column] = value;
                                continue;
                            }
                                
                            data[column].push(value);
                        }
                    }  
                    firstValueRange = false;       
                });
                
                
                console.log(dataHeaders);
                data.forEach(element => {
                    console.log(element);
                });

                // End of JSON formatting

                Chart.defaults.global.defaultFontFamily = "Open Sans";

                var _datasets = [];
                var axisLabels = ["", ""];
                for (var i = 1; i < size; i++)
                {
                    var isRightAxis = false;

                    var axis = 'y-axis-1';
                    for (var j = 0; j < rightAxis.length; j++)
                    {
                        if (rightAxis[j] == i + 1)
                        {
                            axis = 'y-axis-2'
                            isRightAxis = true;
                            break;
                        }
                    }

                    var axisLabel = dataHeaders[i]
                    if (isRightAxis)
                    {
                        if (!axisLabels[1] == "")
                            axisLabels[1] = axisLabels[1] + ", ";
                        axisLabels[1] = axisLabels[1] + axisLabel;
                    }
                    else
                    {
                        if (!axisLabels[0] == "")
                            axisLabels[0] = axisLabels[0] + ", ";
                        axisLabels[0] = axisLabels[0] + axisLabel;
                    }

                    _datasets[i-1] = {
                        label: dataHeaders[i],
                        //For Bar Chart
                        //backgroundColor: "rgba(0, 175, 181, 1)",
                        borderColor: lineOptions.colors[i],
                        data: data[i],
                        fill: false,
                        yAxisID: axis,
                    }
                }

                // End of Line Formatting

                new Chart(document.getElementById('myChart'),
                {
                    type: 'line',
                    data: {
                        labels: data[0],
                        // datasets: _datasets,
                        datasets: _datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        title: {
                            display: false,
                        },
                        tooltips: {
                            mode: 'index',
                            intersect: false,
                        },
                        hover: {
                            mode: 'nearest',
                            intersect: true
                        },
                        scales: {
                            xAxes: [{
                                display: true,
                                scaleLabel: {
                                    display: false,
                                    //labelString: dataHeaders[0]
                                },
                                gridLines: {
                                    borderDash: [2, 2]
                                },
                                ticks: {
                                    // autoSkip: true,
                                    // maxTicksLimit: 10,
                                    //maxRotation: 0
                                }
                            }],
                            yAxes: [{
                                display: true,
                                position: 'left',
                                id: 'y-axis-1',
                                scaleLabel: {
                                    display: true,
                                    labelString: axisLabels[0]
                                },
                                gridLines: {
                                    borderDash: [2, 2]
                                }
                            },
                            {
                                display: true,
                                position: 'right',
                                id: 'y-axis-2',
                                scaleLabel: {
                                    display: true,
                                    labelString: axisLabels[1]
                                },
                                gridLines: {
                                    display: false,
                                    borderDash: [2, 2]
                                }
                            }]
                        },
                        elements: {
                            point:{
                                radius: 0
                            },
                        },
                        legend: {
                            display:false
                        }
                    }
                });
            });
        }
    </script>
</body>
</html>